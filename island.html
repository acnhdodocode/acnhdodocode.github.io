<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ÊéíÈöäË©≥ÊÉÖ (Queue Detail)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Nunito',sans-serif;background:#F5F5E8;color:#8B5A2B;padding:20px;margin:0}
        .container{max-width:800px;margin:0 auto}
        .section{background:white;padding:20px;border-radius:15px;border:2px solid #96C8A4;margin-bottom:20px}
        ul{list-style:none;padding:0}
        li{padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
        .btn{padding:10px 20px;border:none;border-radius:8px;color:white;cursor:pointer;font-weight:bold;margin:5px}
        .blue{background:#2980b9} .green{background:#27ae60} .red{background:#c0392b}
        .wait{color:#e67e22;font-weight:bold} .play{color:#27ae60;font-weight:bold}
        .pending{color:#d35400;font-weight:bold;animation: blink 1s infinite;}
        @keyframes blink { 50% { opacity: 0.5; } }
        .chat-box { max-height: 300px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; }
        .msg-item { margin-bottom: 8px; padding: 5px; border-bottom: 1px dashed #eee; }
        .msg-user { font-weight: bold; color: #4A7A5C; font-size: 0.9rem; }
        .input-group { display: flex; gap: 10px; }
        .input-group input { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; }
        .dodo-highlight { font-size: 2.5rem; color: #27ae60; font-weight: 900; background: #e8f8f5; padding: 10px; border-radius: 10px; border: 2px dashed #27ae60; margin: 10px 0; letter-spacing: 5px; }
        .lang-switcher{text-align:center;margin-bottom:20px;font-size:0.9rem}.lang-switcher a{color:var(--ac-blue);text-decoration:none;padding:0 5px}
    </style>
</head>
<body>
    <div class="container">
        <div class="lang-switcher">
          <a href="?lang=zh">‰∏≠Êñá</a> | 
          <a href="?lang=en">EN</a> | 
          <a href="?lang=ja">Êó•Êú¨Ë™û</a>
        </div>
        <a href="index.html" style="text-decoration:none;color:#73a0c0;font-weight:bold" data-i18n="home_link">‚Üê ËøîÂàóË°®</a>
        
        <div id="info" class="section" style="text-align:center" data-i18n="loading">ËºâÂÖ•‰∏≠...</div>
        
        <div class="section" style="border-color:#73a0c0">
            <h3 data-i18n="queue_title">üë´ ÊéíÈöäÂàóË°® (ÊØè5ÁßíÊõ¥Êñ∞)</h3>
            <div id="status-bar" style="margin-bottom:10px;font-weight:bold"></div>
            <ul id="list"></ul>
            <div id="action" style="text-align:center;padding:20px;background:#ecf0f1;border-radius:10px;margin-top:20px"></div>
            <div id="notice-box" style="display:none;margin-top:20px;padding:15px;background:#fff3cd;border:1px solid #ffeeba;color:#856404;border-radius:10px">
                <h4 style="margin:0 0 10px 0" data-i18n="notice_title">‚ö†Ô∏è Â≥∂‰∏ªÊ≥®ÊÑè‰∫ãÈ†Ö</h4>
                <div id="notice-content" style="white-space:pre-line"></div>
            </div>
        </div>

        <div class="section" style="border-color:#f1c40f">
            <h3 data-i18n="chat_title">üí¨ ÁïôË®ÄÊùø</h3>
            <div id="chat-list" class="chat-box"></div>
            <div class="input-group">
                <input type="text" id="chat-input" data-i18n-placeholder="chat_placeholder" placeholder="Ë´ãËº∏ÂÖ•ÁïôË®Ä...">
                <button onclick="sendComment()" class="btn blue" style="margin:0" data-i18n="chat_send">ÁôºÈÄÅ</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://api.ttctv-105.cc";
        const urlParams = new URLSearchParams(window.location.search);
        const hostEmail = urlParams.get('host');
        const user = JSON.parse(localStorage.getItem('acnh_user'));

        const translations = {
            'zh': {
                'home_link': '‚Üê ËøîÂàóË°®', 'loading': 'ËºâÂÖ•‰∏≠...', 'queue_title': 'üë´ ÊéíÈöäÂàóË°® (ÊØè5ÁßíÊõ¥Êñ∞)',
                'notice_title': '‚ö†Ô∏è Â≥∂‰∏ªÊ≥®ÊÑè‰∫ãÈ†Ö', 'chat_title': 'üí¨ ÁïôË®ÄÊùø', 'chat_placeholder': 'Ë´ãËº∏ÂÖ•ÁïôË®Ä...', 'chat_send': 'ÁôºÈÄÅ',
                'status_visitors': 'Â≥∂‰∏ä‰∫∫Êï∏', 'status_full': '(Â∑≤Êªø)', 'status_avail': '(ÊúâÂêçÈ°ç)', 'no_queue': 'Êö´ÊôÇÂÜá‰∫∫ÊéíÈöä',
                'status_playing': 'üèùÔ∏è Áé©Ê®Ç‰∏≠', 'status_timeup': 'ÊôÇÈñìÂà∞', 'status_entering': 'üîî Ë´ãÂÖ•Â≥∂ÔºÅÂâ©È§ò', 'status_sec': 'Áßí',
                'status_timeout': 'ÈÄæÊôÇ', 'status_waiting': 'Á≠âÂæÖ‰∏≠',
                'btn_login': 'Ë´ãÂÖàÁôªÂÖ•', 'btn_host': '‰Ω†‰øÇÂ≥∂‰∏ªÔºåÂèØÊñºÊ≠§È†ÅÂõûË¶ÜÁïôË®Ä„ÄÇ', 'btn_join': '‚ûï Âä†ÂÖ•ÊéíÈöä',
                'btn_wait_text': 'ÊéíÈöä‰∏≠... Ëº™Âà∞‰Ω†ÊôÇ Code ÊúÉËá™ÂãïÈ°ØÁ§∫„ÄÇ', 'btn_leave_q': '‚ùå ÂîîÊéí‰∫Ü',
                'btn_pending_title': 'üéâ Ëº™Âà∞‰Ω†‰∫ÜÔºÅCode Â∑≤È°ØÁ§∫ÔºÅ', 'btn_pending_text': 'Ë´ãÊñº $s ÁßíÂÖßÊàêÂäüËµ∑È£õ‰∏¶Êåâ‰∏ãÁ¢∫Ë™çÔºÅ',
                'btn_pending_go': '‚úàÔ∏è ÊàëÂ∑≤ÊàêÂäüËµ∑È£õ', 'btn_pending_giveup': '‚ùå ÊîæÊ£ÑÊ©üÊúÉ',
                'btn_onisland_title': 'Ë®àÊôÇ‰∏≠ÔºÅË´ãÊñº 10 ÂàÜÈêòÂÖßÈõ¢Èñã„ÄÇ', 'btn_onisland_leave': 'üëã ÊàëÂ∑≤Èõ¢ÈñãÂ≥∂Â∂º'
            },
            'en': {
                'home_link': '‚Üê Back to List', 'loading': 'Loading...', 'queue_title': 'üë´ Queue List (Updates every 5s)',
                'notice_title': '‚ö†Ô∏è Host\'s Notice', 'chat_title': 'üí¨ Chat', 'chat_placeholder': 'Enter message...', 'chat_send': 'Send',
                'status_visitors': 'Visitors on Island', 'status_full': '(Full)', 'status_avail': '(Available)', 'no_queue': 'No one in queue',
                'status_playing': 'üèùÔ∏è On Island', 'status_timeup': 'Time\'s Up', 'status_entering': 'üîî Entering! Remaining', 'status_sec': 's',
                'status_timeout': 'Timeout', 'status_waiting': 'Waiting',
                'btn_login': 'Please Login', 'btn_host': 'You are the host. You can reply to chat.', 'btn_join': '‚ûï Join Queue',
                'btn_wait_text': 'Waiting... Dodo Code will show when it\'s your turn.', 'btn_leave_q': '‚ùå Leave Queue',
                'btn_pending_title': 'üéâ It\'s Your Turn! Code is visible!', 'btn_pending_text': 'Please depart and confirm within $s seconds!',
                'btn_pending_go': '‚úàÔ∏è I\'ve Departed', 'btn_pending_giveup': '‚ùå Give Up',
                'btn_onisland_title': 'Timer Running! Please leave within 10 mins.', 'btn_onisland_leave': 'üëã I\'ve Left Island'
            },
            'ja': {
                'home_link': '‚Üê „É™„Çπ„Éà„Å´Êàª„Çã', 'loading': 'Ë™≠„ÅøËæº„Åø‰∏≠...', 'queue_title': 'üë´ ÂæÖÊ©üÂàó (5ÁßíÊõ¥Êñ∞)',
                'notice_title': '‚ö†Ô∏è „Éõ„Çπ„Éà„Åã„Çâ„ÅÆÊ≥®ÊÑè‰∫ãÈ†Ö', 'chat_title': 'üí¨ „ÉÅ„É£„ÉÉ„Éà', 'chat_placeholder': '„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ...', 'chat_send': 'ÈÄÅ‰ø°',
                'status_visitors': 'Â≥∂ÂÜÖ„ÅÆ‰∫∫Êï∞', 'status_full': '(Ê∫ÄÂì°)', 'status_avail': '(Á©∫„Åç„ÅÇ„Çä)', 'no_queue': 'ÂæÖÊ©üÂàó„ÅØ„ÅÑ„Åæ„Åõ„Çì',
                'status_playing': 'üèùÔ∏è Ë®™Âïè‰∏≠', 'status_timeup': 'ÊôÇÈñìÂàá„Çå', 'status_entering': 'üîî ÂÖ•Â≥∂„Å©„ÅÜ„ÅûÔºÅÊÆã„Çä', 'status_sec': 'Áßí',
                'status_timeout': 'ÊôÇÈñìË∂ÖÈÅé', 'status_waiting': 'ÂæÖÊ©ü‰∏≠',
                'btn_login': '„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'btn_host': '„ÅÇ„Å™„Åü„ÅØ„Éõ„Çπ„Éà„Åß„Åô„ÄÇ„ÉÅ„É£„ÉÉ„Éà„Å´Ëøî‰ø°„Åß„Åç„Åæ„Åô„ÄÇ', 'btn_join': '‚ûï ÂæÖÊ©üÂàó„Å´ÂèÇÂä†',
                'btn_wait_text': 'ÂæÖÊ©ü‰∏≠... È†ÜÁï™„ÅåÊù•„Åü„Çâ„Ç≥„Éº„Éâ„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ', 'btn_leave_q': '‚ùå ÂæÖÊ©üÂàó„Åã„ÇâÈõ¢ËÑ±',
                'btn_pending_title': 'üéâ „ÅÇ„Å™„Åü„ÅÆÁï™„Åß„ÅôÔºÅ„Ç≥„Éº„ÉâË°®Á§∫‰∏≠ÔºÅ', 'btn_pending_text': '$s Áßí‰ª•ÂÜÖ„Å´È£õË°åÊ©ü„Å´‰πó„Å£„Å¶Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ',
                'btn_pending_go': '‚úàÔ∏è Âá∫Áô∫„Åó„Åæ„Åó„Åü', 'btn_pending_giveup': '‚ùå ËæûÈÄÄ„Åô„Çã',
                'btn_onisland_title': '„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥‰∏≠ÔºÅ10ÂàÜ‰ª•ÂÜÖ„Å´ÈÄÄÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'btn_onisland_leave': 'üëã Â≥∂„Åã„ÇâÂá∫„Åæ„Åó„Åü'
            }
        };

        function getLanguage() {
            const urlLang = new URLSearchParams(window.location.search).get('lang');
            if (urlLang && translations[urlLang]) return urlLang;
            const browserLang = navigator.language.split('-')[0];
            if (browserLang && translations[browserLang]) return browserLang;
            return 'zh';
        }
        function translatePage(lang) {
            const langDict = translations[lang] || translations['zh'];
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if (langDict[key]) el.innerHTML = langDict[key]; });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { const key = el.getAttribute('data-i18n-placeholder'); if (langDict[key]) el.placeholder = langDict[key]; });
            document.querySelectorAll('a').forEach(a => {
                try {
                    if (a.href && (a.protocol === window.location.protocol || a.protocol === "file:")) {
                        const url = new URL(a.href, window.location.href);
                        if (url.hostname === window.location.hostname || url.protocol === "file:") {
                            if (a.getAttribute('href') !== '#') {
                                url.searchParams.set('lang', lang);
                                a.href = url.href;
                            }
                        }
                    }
                } catch (e) { /* ignore */ }
            });
        }
        
        const currentLang = getLanguage();
        const t = translations[currentLang] || translations['zh'];
        document.addEventListener('DOMContentLoaded', () => translatePage(currentLang));

        setInterval(loadData, 5000);
        loadData();

        async function loadData() {
            if(!hostEmail) return;
            const myEmail = user ? user.email : '';
            try {
                const res = await fetch(`${API_URL}/island-detail?hostEmail=${encodeURIComponent(hostEmail)}&visitorEmail=${encodeURIComponent(myEmail)}`);
                const json = await res.json();

                if(json.status === 'error') {
                    document.getElementById('info').innerHTML = `<h2>${json.message}</h2>`;
                    document.getElementById('action').style.display = 'none';
                    return;
                }
                
                renderInfo(json.island);
                renderQueue(json.queue, json.serverTime, json.island);
                renderComments(json.comments);
            } catch(e) { console.log(e); }
        }

        function renderInfo(island) {
            const isHost = user && user.email === island.user_email;
            const dodoDisplay = isHost ? island.dodo_code : "******";
            const dodoStyle = isHost ? "color:#73a0c0" : "color:#ccc;letter-spacing:normal";
            const dodoSub = isHost ? "" : `<div style="font-size:0.9rem;color:#999">(Ëº™Âà∞‰Ω†ÊôÇÈ°ØÁ§∫ / Show when turn)</div>`;

            document.getElementById('info').innerHTML = `
                <h2>üå¥ ${island.island_name}</h2>
                <div style="font-size:2rem;font-weight:bold;margin:10px;letter-spacing:5px;${dodoStyle}">${dodoDisplay}</div>
                ${dodoSub}
                <p><b>Host:</b> ${island.user_email} (Max: ${island.max_visitors})</p>
                <p><b>Note:</b> ${island.note || '-'}</p>
            `;

            if (island.notice) {
                document.getElementById('notice-box').style.display = "block";
                document.getElementById('notice-content').innerText = island.notice;
            } else {
                document.getElementById('notice-box').style.display = "none";
            }
        }

        function renderQueue(queue, serverTimeStr, island) {
            const list = document.getElementById('list');
            const action = document.getElementById('action');
            const statusBar = document.getElementById('status-bar');
            list.innerHTML = "";
            let myStatus = null, myData = null, currentOnIsland = 0;
            const serverNow = new Date(serverTimeStr).getTime();

            queue.forEach(q => {
                if(q.status === 'on_island' || q.status === 'pending_entry') currentOnIsland++;
                if(user && q.visitor_email === user.email) { myStatus = q.status; myData = q; }
            });

            const isFull = currentOnIsland >= island.max_visitors;
            statusBar.innerHTML = `${t.status_visitors}: ${currentOnIsland} / ${island.max_visitors} ${isFull ? `<span style="color:red">${t.status_full}</span>` : `<span style="color:green">${t.status_avail}</span>`}`;

            if(queue.length === 0) list.innerHTML = `<li style='justify-content:center;color:#999'>${t.no_queue}</li>`;

            queue.forEach((q, idx) => {
                let statusHtml = "";
                if(q.status === 'on_island') {
                    const diff = new Date(q.start_time).getTime() + (10*60000) - serverNow;
                    if(diff > 0) {
                        const m = Math.floor(diff/60000); const s = Math.floor((diff%60000)/1000);
                        statusHtml = `<span class="play">${t.status_playing} (${m}m ${s}s)</span>`;
                    } else statusHtml = `<span style="color:red">${t.status_timeup}</span>`;
                } else if (q.status === 'pending_entry') {
                    const diff = Math.floor((new Date(q.pending_start_time).getTime() + 30000 - serverNow)/1000);
                    if(diff > 0) statusHtml = `<span class="pending">${t.status_entering} ${diff} ${t.status_sec}</span>`;
                    else statusHtml = `<span style="color:red">${t.status_timeout}</span>`;
                } else {
                    statusHtml = `<span class="wait">${t.status_waiting}</span>`;
                }
                list.innerHTML += `<li><span>${q.visitor_name}</span>${statusHtml}</li>`;
            });

            if(!user) {
                action.innerHTML = `<a href="login.html" class="btn blue" style="text-decoration:none">${t.btn_login}</a>`;
            } else if(hostEmail === user.email) {
                 action.innerHTML = `<p>${t.btn_host}</p>`;
            } else if(!myStatus) {
                action.innerHTML = `<button onclick="api('join')" class="btn blue">${t.btn_join}</button>`;
            } else if(myStatus === 'waiting') {
                action.innerHTML = `<p>${t.btn_wait_text}</p><button onclick="api('leave')" class="btn red">${t.btn_leave_q}</button>`;
            } else if(myStatus === 'pending_entry') {
                const diff = Math.floor((new Date(myData.pending_start_time).getTime() + 30000 - serverNow)/1000);
                action.innerHTML = `
                    <h3 style="color:#d35400; margin:0;">${t.btn_pending_title}</h3>
                    <p>${t.btn_pending_text.replace('$s', (diff>0?diff:0))}</p>
                    <div class="dodo-highlight">${island.dodo_code}</div>
                    <button onclick="api('enter')" class="btn green">${t.btn_pending_go}</button>
                    <button onclick="api('leave')" class="btn red">${t.btn_pending_giveup}</button>
                `;
            } else if(myStatus === 'on_island') {
                action.innerHTML = `
                    <h3 style="color:#c0392b">${t.btn_onisland_title}</h3>
                    <button onclick="api('leave')" class="btn red">${t.btn_onisland_leave}</button>
                `;
            }
        }

        function renderComments(comments) {
            const chatList = document.getElementById('chat-list');
            let html = "";
            if(!comments || comments.length === 0) html = "<div style='color:#999;text-align:center'>Êö´ÊôÇÊú™ÊúâÁïôË®Ä</div>";
            else {
                comments.forEach(c => {
                    const time = new Date(c.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    const isHost = c.user_email === hostEmail ? " (Host)" : "";
                    const style = c.user_email === hostEmail ? "color:#d35400" : "";
                    html += `<div class="msg-item"><span class="msg-user" style="${style}">${c.user_name}${isHost}</span><span class="msg-time">${time}</span><div>${c.message}</div></div>`;
                });
            }
            chatList.innerHTML = html;
        }

        async function sendComment() {
            const input = document.getElementById('chat-input');
            if(!user) { alert(t.btn_login); return; }
            if(!input.value.trim()) return;
            try {
                await fetch(`${API_URL}/comment`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ hostEmail, userEmail: user.email, userName: user.username, message: input.value.trim() }) });
                input.value = ""; loadData();
            } catch(e) { alert("Failed"); }
        }

        async function api(act) {
            const res = await fetch(`${API_URL}/queue/${act}`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ hostEmail, visitorEmail: user.email, visitorName: user.username }) });
            const json = await res.json();
            if(json.status === 'error') alert(json.message);
            loadData();
        }
    </script>
</body>
</html>
