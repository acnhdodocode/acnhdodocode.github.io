<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ACNH Admin Panel (v1.1)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Nunito',sans-serif;background:#2c3e50;color:#ecf0f1;padding:20px;margin:0}
        .container{max-width:1100px;margin:20px auto}
        
        .login-box { max-width: 350px; margin: 100px auto; background: #34495e; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .login-box h2 { color: #e74c3c; margin-bottom: 25px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; box-sizing: border-box; font-size: 1rem; }
        .login-box button { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; cursor: pointer; border-radius: 8px; font-weight: bold; margin-top: 10px; }
        
        #admin-content { display: none; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        h2.section-title { color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 40px; }

        .card{background:#34495e;padding:20px;border-radius:10px;margin-bottom:20px; border-left: 5px solid #e74c3c; box-shadow: 0 4px 6px rgba(0,0,0,0.1)}
        .island-card { border-left: 5px solid #3498db; }

        table{width:100%;border-collapse:collapse;margin-top:10px; background: #2c3e50; border-radius: 8px; overflow: hidden;}
        th,td{padding:15px;text-align:left;border-bottom:1px solid #465a6e}
        th{background:#1a252f; color: #95a5a6; font-size: 0.85rem; text-transform: uppercase;}
        
        .btn-kick{background:#e74c3c;color:white;border:none;padding:8px 12px;border-radius:5px;cursor:pointer; font-weight:bold;}
        .btn-close{background:#f39c12;color:white;border:none;padding:8px 12px;border-radius:5px;cursor:pointer; font-weight:bold;}
        .btn-refresh{background:#3498db; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold;}
        .btn-logout{background: #95a5a6; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;}

        .status-tag{padding:4px 10px;border-radius:20px;font-size:0.75rem;font-weight:bold; color: white;}
        .tag-on{background:#27ae60} .tag-wait{background:#f39c12} .tag-pend{background:#2980b9}
    </style>
</head>
<body>
    <div id="login-section" class="login-box">
        <h2>ğŸ› ï¸ Admin Login</h2>
        <input type="text" id="admin-id" placeholder="Admin ID">
        <input type="password" id="admin-pw" placeholder="Password">
        <button onclick="doAdminLogin()">Login</button>
        <p id="login-msg" style="color:#ff7675; margin-top:10px;"></p>
        <a href="index.html" style="color:#95a5a6; text-decoration:none; font-size:0.8rem; display:block; margin-top:20px;">â† è¿”å›é¦–é </a>
    </div>

    <div id="admin-content" class="container">
        <div class="header-bar">
            <h1>ğŸ› ï¸ å…¨æœæ’éšŠç®¡ç†ç³»çµ± <small style="font-size: 0.5em; color: #95a5a6;">(v1.1)</small></h1>
            <div>
                <button class="btn-refresh" onclick="loadAllData()">åˆ·æ–° (Refresh)</button>
                <button class="btn-logout" onclick="logoutAdmin()">ç™»å‡º (Logout)</button>
            </div>
        </div>

        <h2 class="section-title">ğŸï¸ é–‹æ”¾ä¸­çš„å³¶å¶¼ (Open Islands)</h2>
        <div id="island-list">è¼‰å…¥ä¸­...</div>

        <h2 class="section-title">ğŸ‘« æ­£åœ¨æ’éšŠçš„äºº (Queues)</h2>
        <div id="queue-list">è¼‰å…¥ä¸­...</div>
    </div>

    <script>
        const API_URL = "https://api.ttctv-105.cc"; 
        const loginSection = document.getElementById('login-section');
        const adminContent = document.getElementById('admin-content');

        window.onload = () => {
            if (sessionStorage.getItem('admin_token')) showAdminArea();
        };

        async function doAdminLogin() {
            const id = document.getElementById('admin-id').value;
            const pw = document.getElementById('admin-pw').value;
            try {
                const res = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, pw })
                });
                const data = await res.json();
                if (data.status === 'success') {
                    sessionStorage.setItem('admin_token', data.adminToken);
                    showAdminArea();
                } else {
                    document.getElementById('login-msg').innerText = data.message;
                }
            } catch (e) { alert("é€£ç·šå¤±æ•—"); }
        }

        function showAdminArea() {
            loginSection.style.display = 'none';
            adminContent.style.display = 'block';
            loadAllData();
        }

        function logoutAdmin() {
            sessionStorage.removeItem('admin_token');
            window.location.reload();
        }

        async function loadAllData() {
            const token = sessionStorage.getItem('admin_token');
            try {
                // 1. ç²å–æ‰€æœ‰å³¶å¶¼è³‡æ–™
                const resIslands = await fetch(`${API_URL}/islands`);
                const jsonIslands = await resIslands.json();
                renderIslands(jsonIslands.data);

                // 2. ç²å–æ‰€æœ‰æ’éšŠè³‡æ–™
                const resQueues = await fetch(`${API_URL}/admin/all-queues`, {
                    headers: { 'Authorization': token }
                });
                if (resQueues.status === 403) return logoutAdmin();
                const jsonQueues = await resQueues.json();
                renderQueues(jsonQueues.data);
            } catch(e) { console.error(e); }
        }

        function renderIslands(data) {
            const container = document.getElementById('island-list');
            if(!data || data.length === 0) {
                container.innerHTML = "ç›®å‰æ²’æœ‰ä»»ä½•å³¶å¶¼é–‹æ”¾ä¸­ã€‚";
                return;
            }
            let html = "<table><tr><th>å³¶å</th><th>Host Email</th><th>é–‹æ”¾æ™‚é–“</th><th>æ“ä½œ</th></tr>";
            data.forEach(is => {
                html += `
                    <tr>
                        <td><b>${is.island_name}</b></td>
                        <td>${is.user_email}</td>
                        <td>${new Date(is.created_at).toLocaleString()}</td>
                        <td><button class="btn-close" onclick="forceCloseIsland('${is.user_email}')">å¼·åˆ¶é—œé–‰ (Close)</button></td>
                    </tr>
                `;
            });
            html += "</table>";
            container.innerHTML = html;
        }

        function renderQueues(data) {
            const container = document.getElementById('queue-list');
            if(!data || data.length === 0) {
                container.innerHTML = "ç›®å‰æ²’æœ‰äººåœ¨æ’éšŠã€‚";
                return;
            }
            let html = "";
            let currentIsland = "";
            data.forEach(item => {
                if(item.island_host_email !== currentIsland) {
                    if(currentIsland !== "") html += `</table></div>`;
                    currentIsland = item.island_host_email;
                    html += `<div class="card"><h3>ğŸï¸ å³¶ä¸»: ${item.island_host_email}</h3><table><tr><th>ç©å®¶</th><th>ç‹€æ…‹</th><th>åŠ å…¥æ™‚é–“</th><th>æ“ä½œ</th></tr>`;
                }
                let statusClass = item.status === 'on_island' ? 'tag-on' : (item.status === 'pending_entry' ? 'tag-pend' : 'tag-wait');
                html += `
                    <tr>
                        <td><b>${item.visitor_name}</b></td>
                        <td><span class="status-tag ${statusClass}">${item.status.toUpperCase()}</span></td>
                        <td>${new Date(item.joined_at).toLocaleTimeString()}</td>
                        <td><button class="btn-kick" onclick="kickUser('${item.island_host_email}', '${item.visitor_email}', '${item.visitor_name}')">è¸¢èµ° (Kick)</button></td>
                    </tr>
                `;
            });
            html += `</table></div>`;
            container.innerHTML = html;
        }

        async function forceCloseIsland(email) {
            if(!confirm(`è­¦å‘Šï¼šç¢ºå®šè¦å¼·åˆ¶é—œé–‰ ${email} çš„å³¶å¶¼å—ï¼Ÿ\næ‰€æœ‰æ’éšŠçš„äººæœƒè¢«è¸¢å‡ºï¼Œç•™è¨€ä¹Ÿæœƒè¢«æ¸…ç©ºã€‚`)) return;
            const token = sessionStorage.getItem('admin_token');
            const res = await fetch(`${API_URL}/admin/close-island`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ targetHostEmail: email })
            });
            const data = await res.json();
            alert(data.message);
            loadAllData();
        }

        async function kickUser(islandEmail, visitorEmail, visitorName) {
            if(!confirm(`ç¢ºå®šè¦å°‡ã€Œ${visitorName}ã€è¸¢å‡ºéšŠä¼ï¼Ÿ`)) return;
            const token = sessionStorage.getItem('admin_token');
            const res = await fetch(`${API_URL}/admin/kick`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': token },
                body: JSON.stringify({ targetIslandEmail: islandEmail, targetVisitorEmail: visitorEmail })
            });
            const data = await res.json();
            alert(data.message);
            loadAllData();
        }
    </script>
</body>
</html>
