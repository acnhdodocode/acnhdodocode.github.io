<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ACNH Admin Panel (v1.0)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Nunito',sans-serif;background:#2c3e50;color:#ecf0f1;padding:20px;margin:0}
        .container{max-width:1000px;margin:20px auto}
        
        /* ç™»å…¥æ¡†æ¨£å¼ */
        .login-box { max-width: 350px; margin: 100px auto; background: #34495e; padding: 40px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
        .login-box h2 { color: #e74c3c; margin-bottom: 25px; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; box-sizing: border-box; font-size: 1rem; }
        .login-box button { width: 100%; padding: 12px; background: #e74c3c; color: white; border: none; cursor: pointer; border-radius: 8px; font-weight: bold; font-size: 1rem; margin-top: 10px; }
        .login-box button:hover { background: #c0392b; }
        #login-msg { color: #ff7675; font-size: 0.9rem; margin-top: 15px; }

        /* ç®¡ç†ç•Œé¢æ¨£å¼ */
        #admin-content { display: none; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card{background:#34495e;padding:20px;border-radius:10px;margin-bottom:20px;border-left:5px solid #e74c3c; box-shadow: 0 4px 6px rgba(0,0,0,0.1)}
        table{width:100%;border-collapse:collapse;margin-top:10px; background: #2c3e50; border-radius: 8px; overflow: hidden; }
        th,td{padding:15px;text-align:left;border-bottom:1px solid #465a6e}
        th{background:#1a252f; color: #95a5a6; font-size: 0.85rem; text-transform: uppercase;}
        
        .btn-kick{background:#e74c3c;color:white;border:none;padding:8px 15px;border-radius:5px;cursor:pointer; font-weight: bold;}
        .btn-kick:hover{background:#c0392b}
        .btn-refresh{background:#3498db; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;}
        .btn-logout{background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;}

        .status-tag{padding:4px 10px;border-radius:20px;font-size:0.75rem;font-weight:bold; color: white;}
        .tag-on{background:#27ae60} .tag-wait{background:#f39c12} .tag-pend{background:#2980b9}
    </style>
</head>
<body>
    <div id="login-section" class="login-box">
        <h2>ğŸ› ï¸ Admin Login</h2>
        <input type="text" id="admin-id" placeholder="Admin ID">
        <input type="password" id="admin-pw" placeholder="Password">
        <button onclick="doAdminLogin()">Login</button>
        <p id="login-msg"></p>
        <a href="index.html" style="color: #95a5a6; text-decoration: none; font-size: 0.8rem; display: block; margin-top: 20px;">â† è¿”å›é¦–é </a>
    </div>

    <div id="admin-content" class="container">
        <div class="header-bar">
            <h1>ğŸ› ï¸ å…¨æœæ’éšŠç®¡ç†ç³»çµ± <small style="font-size: 0.5em; color: #95a5a6;">(Authorized)</small></h1>
            <div>
                <button class="btn-refresh" onclick="loadAllData()">åˆ·æ–° (Refresh)</button>
                <button class="btn-logout" onclick="logoutAdmin()">ç™»å‡º (Logout)</button>
            </div>
        </div>
        <hr style="border: 0; border-top: 1px solid #465a6e; margin-bottom: 20px;">
        <div id="main-list">è¼‰å…¥æ•¸æ“šä¸­...</div>
    </div>

    <script>
        const API_URL = "https://api.ttctv-105.cc"; // ç¢ºä¿èˆ‡ server.js ç¶²å€ä¸€è‡´
        const loginSection = document.getElementById('login-section');
        const adminContent = document.getElementById('admin-content');

        // é é¢åŠ è¼‰æ™‚æª¢æŸ¥ Token
        window.onload = () => {
            if (sessionStorage.getItem('admin_token')) {
                showAdminArea();
            }
        };

        // --- ç®¡ç†å“¡ç™»å…¥ ---
        async function doAdminLogin() {
            const id = document.getElementById('admin-id').value;
            const pw = document.getElementById('admin-pw').value;
            const msg = document.getElementById('login-msg');
            
            msg.innerText = "é©—è­‰ä¸­...";

            try {
                const res = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, pw })
                });
                const data = await res.json();
                
                if (data.status === 'success') {
                    // å°‡å¾Œç«¯ç”Ÿæˆçš„ Token å­˜å…¥ Session
                    sessionStorage.setItem('admin_token', data.adminToken);
                    showAdminArea();
                } else {
                    msg.innerText = data.message;
                }
            } catch (e) {
                msg.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Port 9002 æ˜¯å¦é–‹å•Ÿ";
            }
        }

        function showAdminArea() {
            loginSection.style.display = 'none';
            adminContent.style.display = 'block';
            loadAllData();
        }

        function logoutAdmin() {
            sessionStorage.removeItem('admin_token');
            window.location.reload();
        }

        // --- ç²å–æ•¸æ“š (æ”œå¸¶ Token) ---
        async function loadAllData() {
            const token = sessionStorage.getItem('admin_token');
            const listContainer = document.getElementById('main-list');

            try {
                const res = await fetch(`${API_URL}/admin/all-queues`, {
                    headers: { 'Authorization': token }
                });

                if (res.status === 403) {
                    alert("ç™»å…¥é€¾æ™‚æˆ–ç„¡æ¬Šé™ï¼Œè«‹é‡æ–°ç™»å…¥");
                    return logoutAdmin();
                }

                const json = await res.json();
                renderTable(json.data);
            } catch(e) {
                listContainer.innerHTML = "ç„¡æ³•é€£æ¥ä¼ºæœå™¨ / Connection Error";
            }
        }

        function renderTable(data) {
            const container = document.getElementById('main-list');
            if(!data || data.length === 0) {
                container.innerHTML = "<div style='text-align:center; padding: 40px; color: #95a5a6;'>ç›®å‰æ²’æœ‰ä»»ä½•ç©å®¶åœ¨éšŠä¼ä¸­ã€‚</div>";
                return;
            }

            let html = "";
            let currentIsland = "";

            data.forEach(item => {
                if(item.island_host_email !== currentIsland) {
                    if(currentIsland !== "") html += `</table></div>`;
                    currentIsland = item.island_host_email;
                    html += `
                        <div class="card">
                            <h3>ğŸï¸ å³¶å¶¼: ${item.island_name} <span style="font-size: 0.8rem; font-weight: normal; color: #95a5a6;">(${item.island_host_email})</span></h3>
                            <table>
                                <tr>
                                    <th style="width: 40%;">ç©å®¶ (Visitor)</th>
                                    <th style="width: 20%;">ç‹€æ…‹ (Status)</th>
                                    <th style="width: 20%;">åŠ å…¥æ™‚é–“</th>
                                    <th style="width: 20%;">æ“ä½œ</th>
                                </tr>
                    `;
                }

                let statusClass = item.status === 'on_island' ? 'tag-on' : (item.status === 'pending_entry' ? 'tag-pend' : 'tag-wait');
                
                html += `
                    <tr>
                        <td><b>${item.visitor_name}</b><br><small style="color: #95a5a6;">${item.visitor_email}</small></td>
                        <td><span class="status-tag ${statusClass}">${item.status.toUpperCase()}</span></td>
                        <td>${new Date(item.joined_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                        <td>
                            <button class="btn-kick" onclick="kickUser('${item.island_host_email}', '${item.visitor_email}', '${item.visitor_name}')">
                                è¸¢èµ° (Kick)
                            </button>
                        </td>
                    </tr>
                `;
            });
            html += `</table></div>`;
            container.innerHTML = html;
        }

        // --- å¼·åˆ¶è¸¢äºº (æ”œå¸¶ Token) ---
        async function kickUser(islandEmail, visitorEmail, visitorName) {
            if(!confirm(`ç¢ºå®šè¦å°‡ã€Œ${visitorName}ã€å¼·åˆ¶è¸¢å‡ºéšŠä¼å—ï¼Ÿ\nç³»çµ±å°‡è‡ªå‹•è£œä¸Šä¸‹ä¸€ä½ç­‰å€™è€…ã€‚`)) return;

            const token = sessionStorage.getItem('admin_token');

            try {
                const res = await fetch(`${API_URL}/admin/kick`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': token 
                    },
                    body: JSON.stringify({
                        targetIslandEmail: islandEmail,
                        targetVisitorEmail: visitorEmail
                    })
                });
                const result = await res.json();
                
                if (result.status === 'success') {
                    loadAllData(); // æˆåŠŸå¾Œåˆ·æ–°åˆ—è¡¨
                } else {
                    alert(result.message);
                }
            } catch(e) {
                alert("æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²çµ¡é€£çµ");
            }
        }
    </script>
</body>
</html>
